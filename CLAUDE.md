# CLAUDE.md — WeldQAi Development Guide

This file is the authoritative guide for all AI-assisted development on this codebase.
Read it fully before making any changes.

---

## Project Overview

WeldQAi is a Flutter/Firebase SaaS application for welding and industrial QA/QC inspection.
It serves paying customers. Production bugs have real consequences.

**Stack:** Flutter (SDK ^3.8.1, Material 3), Firebase (Firestore, Auth, Storage, Functions,
App Check, Analytics, FCM, Performance), Stripe payments, Node.js Gen2 Cloud Functions.

---

## Critical Rules

### Never Touch Without Explicit Instruction
- `lib/firebase_options.dart` — Firebase config; do not regenerate without FlutterFire CLI
- `functions/index.js` — Production Stripe webhook handler; changes require testing
- `firestore.rules` / `storage.rules` — Security rules; any change must be audited
- `android/app/build.gradle.kts` — Already fixed (ndkVersion 27, minSdk 23, desugaring)

### Known Active Bugs — Do Not Work Around, Fix Properly
See `docs/FIXES_REQUIRED.md` for the prioritised list. The most dangerous:
1. `lib/core/repositories/report_repository.dart` — duplicate `status` map key (lines 558–653)
   corrupts report data silently. The lint suppression `equal_keys_in_map` at line 2 was
   hiding this — do not re-add that suppression.
2. `lib/main.dart` — `AndroidProvider.debug` for App Check must become
   `AndroidProvider.playIntegrity` gated behind `kDebugMode`.
3. `lib/core/services/subscription_service.dart` — client writes `hasAccess: true` directly.
   Remove; let the Stripe webhook set it server-side only.

---

## Architecture

### Entry Point
`lib/main.dart` → `lib/app/router.dart` → feature screens

### State Management
Single `ChangeNotifier`: `lib/core/providers/workspace_provider.dart`.
All screens access it via `Provider.of<WorkspaceProvider>()`.
**Do not add more global singletons** — the audit flagged this as a critical smell.
Future work: migrate to Riverpod.

### Data Flow
```
UI Widget
  → Repository (lib/core/repositories/)
    → FirebaseFirestore.instance (direct, no abstraction layer)
      → Cloud Functions (lib/core/services/payment_service.dart)
```
There is no service abstraction layer for Firestore — calls go directly from repositories.
`firestore_service.dart` and `auth_service.dart` were stubs, now deleted.

### Report System (Core Feature)
Schema-driven dynamic forms. Flow:
1. Schema JSON loaded from `assets/schemas/` or `users/{uid}/custom_schemas/` in Firestore
2. `lib/features/reports/base/dynamic_report_form.dart` renders schema (1,426 lines — God Widget, do not add to it)
3. On save: `lib/core/repositories/report_repository.dart` writes to Firestore with delta rollups
4. Export: `lib/core/services/export_service.dart` generates PDF or Excel

### Template Upload Flow
1. User uploads Excel/PDF → `lib/features/reports/widgets/template_upload_button.dart`
2. `lib/core/services/enhanced_template_parser.dart` extracts fields
3. `lib/screens/field_mapping_screen.dart` — user maps/reviews fields
4. `lib/core/services/template_manager.dart` saves to SharedPreferences + Firestore

---

## File Structure (45 active files)

```
lib/
├── main.dart                           Entry, Firebase init, App Check, Provider setup
├── firebase_options.dart               Generated by FlutterFire CLI — do not hand-edit
│
├── app/
│   ├── router.dart                     Named route definitions + Paths class
│   ├── app_theme.dart                  Material 3 light/dark theme
│   └── constants/
│       └── paths.dart                  Route name constants (separate from router Paths — duplicated, known issue)
│
├── core/
│   ├── models/
│   │   ├── chat_message.dart           Chat message DTO
│   │   └── template_mapping.dart       Custom template schema models
│   ├── repositories/
│   │   ├── report_repository.dart      Primary report CRUD + delta rollup stats
│   │   ├── user_data_repository.dart   User profile, KPIs, sharing/collaboration
│   │   ├── metrics_repository.dart     KPI chart data from Firestore
│   │   └── chat_repository.dart        Chat message CRUD + attachments
│   ├── services/
│   │   ├── analytics_service.dart      Firebase Analytics + Performance traces
│   │   ├── notification_service.dart   FCM message handler
│   │   ├── push_service.dart           Device token registration
│   │   ├── sync_service.dart           Offline sync — BUG: reads wrong collection path
│   │   ├── subscription_service.dart   Subscription status checks — BUG: client-side bypass
│   │   ├── pricing_service.dart        Pricing tiers from Firestore with fallback
│   │   ├── payment_service.dart        Stripe checkout via Cloud Functions
│   │   ├── scan_service.dart           OCR scan trigger (camera/gallery)
│   │   ├── formula_engine.dart         Calculated field evaluator (pure Dart)
│   │   ├── export_service.dart         PDF + Excel generation and upload
│   │   ├── enhanced_template_parser.dart  Excel/PDF field extraction
│   │   ├── template_manager.dart       Template CRUD via SharedPreferences
│   │   └── theme_controller.dart       Dark/light mode toggle via SharedPreferences
│   └── providers/
│       └── workspace_provider.dart     Single ChangeNotifier — project + user state
│
├── features/
│   ├── auth/auth_screen.dart           Login / registration
│   ├── welcome/welcome_screen.dart     Landing screen
│   ├── account/
│   │   ├── account_settings_screen.dart
│   │   ├── complete_profile_screen.dart
│   │   └── widgets/upgrade_options_dialog.dart   Subscription upsell dialog
│   ├── reports/
│   │   ├── base/
│   │   │   ├── dynamic_report_form.dart     GOD WIDGET — do not enlarge
│   │   │   ├── dynamic_report_screen.dart   Route wrapper
│   │   │   ├── multi_report_accordion.dart  Report list
│   │   │   └── report_catalog_screen.dart   Template catalog
│   │   └── widgets/
│   │       ├── template_upload_button.dart  Upload Excel/PDF templates
│   │       └── scan_camera_page.dart        Mobile barcode/QR scanner UI
│   ├── projects/project_dashboard_screen.dart
│   ├── sharing/share_access_screen.dart
│   ├── chat/project_chat_screen.dart
│   ├── notifications/notifications_screen.dart
│   └── visualization/
│       ├── visualization_home_screen.dart
│       └── visualization_kpi_screen.dart    Self-contained charts (ChartExporter inline)
│
├── screens/
│   └── field_mapping_screen.dart       Template field mapping wizard (3-step)
│
└── widgets/
    ├── photo_manager_modal.dart         Photo capture + Firebase Storage upload
    └── signature_manager_modal.dart     Signature pad + Firebase Storage upload
```

---

## Firestore Collections

```
/users/{uid}                            User profile document
/users/{uid}/reports/{schemaId}/items/{itemId}   Report entries
/users/{uid}/stats/summary              Aggregated KPI document
/users/{uid}/subscription               Stripe subscription state
/users/{uid}/custom_schemas/{schemaId}  User-uploaded template schemas
/users/{uid}/notifications/{notifId}    In-app notifications
/pricing/{region}                       Pricing tiers by region
/projects/{projectId}/...               Project data (partially implemented)
```

**Firestore Rules Gap (P0):** Rules currently only cover `/users/{uid}` top-level document
and `/projects/{...}`. All subcollections are unprotected. Fix `firestore.rules` urgently.

---

## Cloud Functions (functions/index.js — Node.js Gen2)

- `createCheckoutSession` — Creates Stripe one-time checkout
- `createSubscription` — Creates Stripe recurring subscription
- `stripeWebhook` — Handles payment events (sets `hasAccess`, credits)
- `handleSubscriptionCancelled` — Revokes access on cancellation
- `handlePaymentFailed` — Handles failed renewals

**Bug:** `success_url` and `cancel_url` are placeholder strings. Fix before going live.

---

## Testing

Currently minimal. `test/integration/full_report_flow_test.dart` is a stub.
Target: Firestore emulator tests for report_repository, subscription_service.
Run: `flutter test`

---

## Build

```bash
flutter pub get
flutter analyze           # Should show 0 errors, <50 info warnings
flutter build apk --debug
flutter build apk --release   # Requires signing config in build.gradle.kts
```

Android requirements (already configured):
- NDK: 27.0.12077973
- minSdk: 23
- Core library desugaring: enabled
- `desugar_jdk_libs:2.1.4` in dependencies

---

## Logging

**Always use `AppLogger` — never `print()` or `debugPrint()`.**

```dart
import 'package:weldqai_app/core/services/logger_service.dart';

AppLogger.debug('Sync started for $userId');          // dev-only detail
AppLogger.info('✅ Report saved — $count items');      // milestone / success
AppLogger.warning('⚠️ No schema found, using default');  // unexpected but recoverable
AppLogger.error('❌ Sync failed', error: e, stackTrace: st); // error + ErrorService
AppLogger.fatal('Unrecoverable init failure', error: e);     // crash-level
```

Semantic guide:
- `debug` — detailed trace, only visible in debug builds
- `info` — noteworthy state changes (user action completed, sync finished)
- `warning` — unexpected but handled; investigate if frequent
- `error` — feature impaired; always pass `error:` and `stackTrace:` so Sentry captures it
- `fatal` — app cannot continue; use only in global error handlers

---

## Error Tracking

**Use `ErrorService` to capture exceptions that reach Sentry.**

```dart
import 'package:weldqai_app/core/services/error_service.dart';

try {
  await riskyOperation();
} catch (e, st) {
  AppLogger.error('❌ Operation failed', error: e, stackTrace: st);
  await ErrorService.captureException(e, stackTrace: st, context: 'OperationName');
  rethrow; // or handle gracefully
}
```

---

## Security

### Firestore Rules (`firestore.rules`)

**Rule of thumb: every write must be validated. Every read should be scoped to the minimum audience.**

| Collection | Read | Write |
|---|---|---|
| `/materials/{id}` | Any auth user | Admin only (`isAdmin()`) |
| `/users/{uid}` | Any auth user (needed for sharing lookup) | Owner only |
| `/users/{uid}/subscription/info` | Owner | **`false` — server only** (Admin SDK bypasses rules; Stripe webhook writes here) |
| `/users/{uid}/subscription/trial` | Owner | Owner |
| `/users/{uid}/subscription/credits` | Owner | Owner (credit decrement on report use) |
| `/users/{uid}/meta/{doc}` | Owner + read collaborator | Owner + write collaborator |
| Everything else user-scoped | Owner + collaborator by permission | Owner + write collaborator |

**Never:**
- Write `hasAccess: true` from client code — `subscription/info` write is blocked at the rules level.
- Give read-only collaborators write access to any collection.

**`isAdmin()` identity:** `alvespeters@gmail.com` — hardcoded in both `firestore.rules` and `storage.rules`. Change both if the admin account changes.

### Storage Rules (`storage.rules`)

| Path | Read | Write |
|---|---|---|
| `/branding/**` | Public | Admin only |
| `/reports/{userId}/**` | Owner | Owner |
| `/users/{userId}/channels/**` | Owner + read collaborator (Firestore check) | Owner |
| `/users/{userId}/**` | Owner | Owner |
| Everything else | `false` | `false` |

### Cloud Functions (`functions/index.js`)

- **Never log Stripe secret key material** — even a key prefix like `sk_live_abc...` in GCP logs is a credential leak.
- **Validate `payment_status === 'paid'`** before granting access in `handleCheckoutComplete` (already done).
- **Future:** whitelist `priceId` values server-side against known Stripe price IDs to prevent price manipulation.
- **Future:** move `subscription/credits` deduction into a Cloud Function so clients cannot increment their own credits.

### App Check

```dart
// lib/main.dart — MUST stay this way
androidProvider: kDebugMode ? AndroidProvider.debug : AndroidProvider.playIntegrity,
```

Using `AndroidProvider.debug` in release mode lets any device call Firebase APIs without a valid attestation token — effectively disabling App Check for all Android users.

### `subscription_service.dart` — `createMonthlySubscription()`

This method still writes to `subscription/info` from the client (status, type, Stripe IDs — but NOT `hasAccess`). The write will be **rejected by Firestore rules** (`write: if false`). This is intentional: the Stripe webhook sets `subscription/info` server-side via Admin SDK before the user is redirected back. The client-side call is redundant and can be removed in a future refactor.

---

## What NOT to Do

- Do not add new global singletons
- Do not add more code to `dynamic_report_form.dart` — split it instead
- Do not create new hardcoded report form files (use schema-driven approach)
- Do not add `// ignore_for_file: equal_keys_in_map` to any file
- Do not call `FirebaseFirestore.instance.settings` more than once
- Do not write `hasAccess: true` from client side — server only
- Do not use `AndroidProvider.debug` in production App Check configuration
- Do not use `print()` or `debugPrint()` — use `AppLogger` instead
