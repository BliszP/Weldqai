# WeldQAi — Architecture Document

Last updated: February 2026

---

## System Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENT LAYER                            │
│                                                                 │
│  Flutter App (Android / iOS / Web)                              │
│  ┌──────────┐  ┌──────────────┐  ┌──────────────────────────┐  │
│  │  Screens │  │ Repositories │  │       Services           │  │
│  │(features/│→ │(core/        │→ │(core/services/)          │  │
│  │ screens/ │  │ repositories/│  │ analytics, export,       │  │
│  │ widgets/)│  │)             │  │ scan, sync, payment...   │  │
│  └──────────┘  └──────────────┘  └──────────────────────────┘  │
│        ↕               ↕                    ↕                   │
│  WorkspaceProvider  (lib/core/providers/workspace_provider.dart)│
└────────────────────────────┬────────────────────────────────────┘
                             │ Firebase SDK (direct Firestore calls)
┌────────────────────────────▼────────────────────────────────────┐
│                      FIREBASE LAYER                             │
│                                                                 │
│  Firestore ──────── Auth ──────── Storage ──────── FCM          │
│      │                                                          │
│      └──── App Check ──── Analytics ──── Performance            │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTPS callable
┌────────────────────────────▼────────────────────────────────────┐
│                   CLOUD FUNCTIONS LAYER                         │
│                  (functions/index.js, Gen2)                     │
│                                                                 │
│  createCheckoutSession ──── createSubscription                  │
│  stripeWebhook ──────────── handleSubscriptionCancelled         │
│  handlePaymentFailed                                            │
│                     ↕                                           │
│                  STRIPE API                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## Active File Map (45 files)

### Entry & Configuration
| File | Purpose |
|------|---------|
| `lib/main.dart` | App entry point. Firebase init, App Check setup, Provider tree, router wiring |
| `lib/firebase_options.dart` | Platform-specific Firebase config generated by FlutterFire CLI |
| `lib/app/router.dart` | All named routes; also defines its own `Paths` class (duplicates `app/constants/paths.dart` — known issue) |
| `lib/app/app_theme.dart` | Material 3 `ThemeData` for light and dark mode |
| `lib/app/constants/paths.dart` | Route name string constants |

### State Management
| File | Purpose |
|------|---------|
| `lib/core/providers/workspace_provider.dart` | Single `ChangeNotifier`. Holds current user + project state. Force-unwraps `currentUser!` — crash risk during auth transitions (known bug) |

### Models
| File | Purpose |
|------|---------|
| `lib/core/models/chat_message.dart` | Chat message DTO with Firestore serialisation |
| `lib/core/models/template_mapping.dart` | Custom template schema — `TemplateMapping`, `FieldMapping`, `TableMapping`, `ColumnMapping` |

### Repositories
| File | Purpose |
|------|---------|
| `lib/core/repositories/report_repository.dart` | Primary CRUD for inspection reports. Delta rollup stats using `FieldValue.increment`. **Bug: duplicate `status` key at lines 558–653.** |
| `lib/core/repositories/user_data_repository.dart` | User profile init, KPI streams, sharing/collaboration. `ndtKpisStream()` needs composite Firestore index |
| `lib/core/repositories/metrics_repository.dart` | KPI chart data reads from Firestore |
| `lib/core/repositories/chat_repository.dart` | Chat messages, file attachments, typing indicators |

### Services
| File | Purpose |
|------|---------|
| `lib/core/services/analytics_service.dart` | Firebase Analytics events + Performance custom traces |
| `lib/core/services/notification_service.dart` | FCM message handler (foreground + background) |
| `lib/core/services/push_service.dart` | Device FCM token registration to Firestore |
| `lib/core/services/sync_service.dart` | Offline sync. **Bug: reads `/users/{uid}/reports` (schema docs) instead of `/users/{uid}/reports/{schemaId}/items/{itemId}` (actual data). Zero reports cached offline.** |
| `lib/core/services/subscription_service.dart` | Checks/streams subscription status. **Bug: `createMonthlySubscription()` writes `hasAccess: true` client-side — payment bypass.** |
| `lib/core/services/pricing_service.dart` | Loads pricing tiers from Firestore with hardcoded fallback. 3 tiers: $3 / $14 / $50/month |
| `lib/core/services/payment_service.dart` | Calls Cloud Functions to create Stripe checkout sessions |
| `lib/core/services/scan_service.dart` | Triggers camera/gallery OCR scan via ML Kit |
| `lib/core/services/formula_engine.dart` | Pure Dart formula evaluator for calculated fields |
| `lib/core/services/export_service.dart` | PDF + Excel generation. Fetches branding logos from Firebase Storage |
| `lib/core/services/enhanced_template_parser.dart` | Extracts fields from uploaded Excel/PDF templates |
| `lib/core/services/template_manager.dart` | Saves/loads custom templates via SharedPreferences |
| `lib/core/services/theme_controller.dart` | Persists dark/light preference via SharedPreferences |

### Feature Screens
| File | Purpose |
|------|---------|
| `lib/features/welcome/welcome_screen.dart` | App landing / splash |
| `lib/features/auth/auth_screen.dart` | Email/Google login + registration |
| `lib/features/account/account_settings_screen.dart` | User settings, theme toggle, sync status |
| `lib/features/account/complete_profile_screen.dart` | Post-registration onboarding |
| `lib/features/account/widgets/upgrade_options_dialog.dart` | Subscription tier selection + Stripe checkout trigger |
| `lib/features/projects/project_dashboard_screen.dart` | Project hub — lists reports, nav to sections |
| `lib/features/reports/base/dynamic_report_screen.dart` | Route wrapper for report form |
| `lib/features/reports/base/dynamic_report_form.dart` | **God Widget (1,426 lines).** Renders schema, handles 8 field types, row tables, Firestore save, PDF/Excel export, branding, photo + signature management, OCR, formula evaluation |
| `lib/features/reports/base/multi_report_accordion.dart` | Lists report entries with expand/collapse and export |
| `lib/features/reports/base/report_catalog_screen.dart` | Schema/template catalog + template upload entry |
| `lib/features/reports/widgets/template_upload_button.dart` | FAB that triggers file pick → parse → map → save flow |
| `lib/features/reports/widgets/scan_camera_page.dart` | Full-screen mobile scanner (barcode + QR) |
| `lib/features/sharing/share_access_screen.dart` | Invite users, manage shared access |
| `lib/features/chat/project_chat_screen.dart` | In-project real-time chat |
| `lib/features/notifications/notifications_screen.dart` | Push notification inbox |
| `lib/features/visualization/visualization_home_screen.dart` | Charts feature home (callback-based navigation) |
| `lib/features/visualization/visualization_kpi_screen.dart` | KPI charts. Contains its own `ChartExporter` class inline |

### Shared UI
| File | Purpose |
|------|---------|
| `lib/screens/field_mapping_screen.dart` | 3-step wizard for mapping template fields (Review → Configure → Save) |
| `lib/widgets/photo_manager_modal.dart` | Photo capture/gallery upload to Firebase Storage |
| `lib/widgets/signature_manager_modal.dart` | Digital signature pad + upload to Firebase Storage |

---

## Firestore Data Model

```
/users/{uid}
│   profile fields: displayName, email, company, role,
│                   fcmToken, createdAt, lastSeen
│
├── /reports/{schemaId}
│   │   (schema-level document — title, type, metadata)
│   │
│   └── /items/{itemId}
│           reportId, schemaId, schemaTitle, status,
│           reportStatus, details {}, entries [], createdAt,
│           updatedAt, projectId, reportNumber
│
├── /stats/summary
│       totalReports, passCount, failCount, pendingCount,
│       repairCount, totalWelds, acceptedWelds, rejectedWelds
│
├── /subscription
│       hasAccess, plan, stripeCustomerId, stripeSubscriptionId,
│       currentPeriodEnd, credits, updatedAt
│
├── /custom_schemas/{schemaId}
│       schemaId, title, schema {}, fileName,
│       createdAt, updatedAt, createdBy
│
└── /notifications/{notifId}
        title, body, read, createdAt, type

/pricing/{region}
    currency, currencySymbol, region,
    one_report {amount, stripePriceId, credits},
    five_reports {amount, stripePriceId, credits, promotionLabel},
    monthly {amount, stripePriceId, isRecurring}

/projects/{projectId}
    (partially implemented — project metadata)
```

**Security Gap:** `firestore.rules` only covers `/users/{uid}` (top-level document) and
`/projects/{...}`. All subcollections (`/reports/**`, `/stats/**`, `/subscription/**`,
`/custom_schemas/**`, `/notifications/**`) are not explicitly allowed — catch-all denies.
Either rules are not deployed (open DB) or subcollection writes are failing silently.

---

## Subscription and Payment Flow

```
User taps upgrade
    → upgrade_options_dialog.dart
        → pricing_service.dart (loads tier from Firestore or fallback)
        → payment_service.dart
            → Cloud Function: createCheckoutSession / createSubscription
                → Stripe API creates session
                    → Returns checkout URL
        → Opens Stripe URL in browser
            → User completes payment on Stripe
                → Stripe sends webhook event
                    → Cloud Function: stripeWebhook (validates signature)
                        → Sets users/{uid}/subscription.hasAccess = true
                        → Increments credits (for pay-per-report)
```

**Known gap:** `success_url` and `cancel_url` in Cloud Functions are placeholder strings.
Stripe cannot redirect back to the app after payment.

**Known bypass:** `subscription_service.dart → createMonthlySubscription()` writes
`hasAccess: true` directly from client. Remove this client-side write.

---

## Template Upload Pipeline

```
User taps "Upload Template" FAB
    → template_upload_button.dart
        → FilePicker (xlsx / xls / pdf)
        → enhanced_template_parser.dart
            → Excel: reads sheet, detects header rows, extracts cell addresses
            → PDF: syncfusion text extraction, column detection
            → Returns: {details: [...fields], tables: [{columns: [...]}]}
        → field_mapping_screen.dart (3-step wizard)
            Step 1: Review — drag fields to Details / Entries sections
            Step 2: Configure — set types (text/number/date/dropdown/calculated/textarea)
            Step 3: Save — name and describe the template
        → template_manager.dart (saves to SharedPreferences)
        → Firestore: users/{uid}/custom_schemas/{schemaId}
        → Navigates to /qc_report with the new schemaId
```

---

## Offline Sync Strategy

**Current state:** Broken. Partial implementation exists.

Firestore is configured with `CACHE_SIZE_UNLIMITED` and offline persistence enabled.
This gives automatic local caching of reads and queued writes when offline.

`sync_service.dart` is supposed to do a proactive sync on connectivity restore, but:
1. It reads `/users/{userId}/reports` (schema-level documents) not actual report items
2. It sets Firestore settings a second time (double-init, throws on web)

**Offline UI** exists but is disconnected. Files preserved in `archive/offline_ui/`:
- `offline_mode_screen.dart`
- `widgets/offline_badge.dart`
- `widgets/sync_banner.dart`

**Fix plan (P1):**
1. Fix `sync_service.dart` collection path to `/users/{uid}/reports/{schemaId}/items`
2. Remove double Firestore settings init
3. Wire `offline_badge` and `sync_banner` into `project_dashboard_screen.dart`
4. Connect `offline_mode_screen` to router when connectivity is lost

---

## Known Technical Debt

| Item | Severity | Location |
|------|----------|----------|
| Duplicate `status` map key | CRITICAL | `report_repository.dart:558` |
| App Check debug provider in prod | CRITICAL | `main.dart` |
| Firestore rules subcollection gap | CRITICAL | `firestore.rules` |
| Storage rules missing report paths | CRITICAL | `storage.rules` |
| Stripe placeholder redirect URLs | CRITICAL | `functions/index.js` |
| Client-side payment bypass | CRITICAL | `subscription_service.dart` |
| SyncService wrong collection path | HIGH | `sync_service.dart` |
| WorkspaceProvider force-unwrap crash | HIGH | `workspace_provider.dart` |
| God Widget (1,426 lines) | HIGH | `dynamic_report_form.dart` |
| Duplicate Paths class | MEDIUM | `router.dart` + `app/constants/paths.dart` |
| Dangling expression `userId;` in router | MEDIUM | `router.dart:115` |
| iOS bundle ID placeholder | HIGH | `firebase_options.dart` |
| Debug print() throughout active files | MEDIUM | Multiple files |
| No test coverage | HIGH | `test/` |
| watchStatus() stream never consumed | MEDIUM | `subscription_service.dart` |
| ndtKpisStream() missing composite index | MEDIUM | `user_data_repository.dart` |
