# WeldQAi — Architecture Document

Last updated: February 2026

---

## System Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         CLIENT LAYER                            │
│                                                                 │
│  Flutter App (Android / iOS / Web)                              │
│  ┌──────────┐  ┌──────────────┐  ┌──────────────────────────┐  │
│  │  Screens │  │ Repositories │  │       Services           │  │
│  │(features/│→ │(core/        │→ │(core/services/)          │  │
│  │ screens/ │  │ repositories/│  │ analytics, export,       │  │
│  │ widgets/)│  │)             │  │ scan, sync, payment...   │  │
│  └──────────┘  └──────────────┘  └──────────────────────────┘  │
│        ↕               ↕                    ↕                   │
│  WorkspaceProvider  (lib/core/providers/workspace_provider.dart)│
│  subscriptionStatusProvider  (Riverpod StreamProvider)          │
└────────────────────────────┬────────────────────────────────────┘
                             │ Firebase SDK (direct Firestore calls)
┌────────────────────────────▼────────────────────────────────────┐
│                      FIREBASE LAYER                             │
│                                                                 │
│  Firestore ──────── Auth ──────── Storage ──────── FCM          │
│      │                                                          │
│      └──── App Check ──── Analytics ──── Performance            │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTPS callable
┌────────────────────────────▼────────────────────────────────────┐
│                   CLOUD FUNCTIONS LAYER                         │
│                  (functions/index.js, Gen2)                     │
│                                                                 │
│  createCheckoutSession ──── createSubscription                  │
│  stripeWebhook ──────────── handleSubscriptionCancelled         │
│  handlePaymentFailed                                            │
│                     ↕                                           │
│                  STRIPE API                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## Active File Map (48 files)

### Entry & Configuration
| File | Purpose |
|------|---------|
| `lib/main.dart` | App entry point. Firebase init, App Check (playIntegrity in release / debug in dev), ProviderScope + WorkspaceProvider, router wiring |
| `lib/firebase_options.dart` | Platform-specific Firebase config generated by FlutterFire CLI — do not hand-edit |
| `lib/app/router.dart` | All named routes — reads constants from `app/constants/paths.dart` |
| `lib/app/app_theme.dart` | Material 3 `ThemeData` for light and dark mode |
| `lib/app/constants/paths.dart` | Route name string constants (single source of truth) |

### State Management
| File | Purpose |
|------|---------|
| `lib/core/providers/workspace_provider.dart` | Single `ChangeNotifier`. Holds current user + project state. Null-checked auth guard (crash risk fixed Feb 2026) |
| `lib/core/providers/subscription_providers.dart` | Riverpod `StreamProvider` for subscription status. Shared stream — replaces 3 duplicate Firestore listeners |

### Models
| File | Purpose |
|------|---------|
| `lib/core/models/chat_message.dart` | Chat message DTO with Firestore serialisation |
| `lib/core/models/template_mapping.dart` | Custom template schema — `TemplateMapping`, `FieldMapping`, `TableMapping`, `ColumnMapping` |

### Repositories
| File | Purpose |
|------|---------|
| `lib/core/repositories/report_repository.dart` | Primary CRUD for inspection reports. Delta rollup stats using `FieldValue.increment`. Duplicate `status` key bug fixed Feb 2026 |
| `lib/core/repositories/project_repository.dart` | CRUD for `/users/{uid}/projects/{projectId}`. Streams + one-shot reads. `incrementReportCount()` called atomically on report save |
| `lib/core/repositories/user_data_repository.dart` | User profile init, KPI streams, sharing/collaboration |
| `lib/core/repositories/metrics_repository.dart` | KPI chart data reads from Firestore |
| `lib/core/repositories/chat_repository.dart` | Chat messages, file attachments, typing indicators |

### Services
| File | Purpose |
|------|---------|
| `lib/core/services/analytics_service.dart` | Firebase Analytics events + Performance custom traces |
| `lib/core/services/error_service.dart` | Sentry exception capture wrapper |
| `lib/core/services/logger_service.dart` | `AppLogger` — levelled logging (debug/info/warning/error/fatal). Use instead of print() |
| `lib/core/services/notification_service.dart` | FCM message handler (foreground + background) |
| `lib/core/services/push_service.dart` | Device FCM token registration to Firestore |
| `lib/core/services/sync_service.dart` | Offline sync. Paths fixed Feb 2026 (was reading schema docs, now reads actual items) |
| `lib/core/services/subscription_service.dart` | Checks/streams subscription status. Client-side `hasAccess` write removed Feb 2026 — server-only via webhook |
| `lib/core/services/pricing_service.dart` | Loads pricing tiers from Firestore with hardcoded fallback. 3 tiers: $3 / $14 / $50/month |
| `lib/core/services/payment_service.dart` | Calls Cloud Functions to create Stripe checkout sessions |
| `lib/core/services/scan_service.dart` | Triggers camera/gallery OCR scan via ML Kit |
| `lib/core/services/formula_engine.dart` | Pure Dart formula evaluator for calculated fields |
| `lib/core/services/export_service.dart` | PDF + Excel generation. Fetches branding logos from Firebase Storage |
| `lib/core/services/enhanced_template_parser.dart` | Extracts fields from uploaded Excel/PDF templates |
| `lib/core/services/template_manager.dart` | Saves/loads custom templates via SharedPreferences |
| `lib/core/services/theme_controller.dart` | Persists dark/light preference via SharedPreferences |

### Feature Screens
| File | Purpose |
|------|---------|
| `lib/features/welcome/welcome_screen.dart` | App landing / splash. Hero → How It Works → CTA → Footer |
| `lib/features/auth/auth_screen.dart` | Email/Google login + registration |
| `lib/features/account/account_settings_screen.dart` | User settings, theme toggle, sync status |
| `lib/features/account/complete_profile_screen.dart` | Post-registration onboarding |
| `lib/features/account/widgets/upgrade_options_dialog.dart` | Subscription tier selection + Stripe checkout trigger |
| `lib/features/projects/project_dashboard_screen.dart` | Main authenticated hub. 4-tab bottom nav (Home/Projects/KPIs/Team). Schema tile grid, drawer nav |
| `lib/features/projects/projects_list_screen.dart` | Lists all projects for the user. Filter by Open/Closed/All (client-side). Streams from ProjectRepository |
| `lib/features/projects/project_detail_screen.dart` | Project hub. Info card, Start Inspection entry point, quick stats. Status toggle + edit + delete actions |
| `lib/features/projects/create_project_screen.dart` | Create / edit project form (name, client, location, type, dates) |
| `lib/features/reports/base/dynamic_report_screen.dart` | Route wrapper for report form |
| `lib/features/reports/base/dynamic_report_form.dart` | Core report form. Was 1,429 lines, split to 956. Renders schema, handles 8 field types, Firestore save, PDF/Excel export, branding, photo + signature management, OCR, formula evaluation |
| `lib/features/reports/base/multi_report_accordion.dart` | Lists report entries with expand/collapse and export |
| `lib/features/reports/base/report_catalog_screen.dart` | Schema/template catalog. Built-in reports in collapsible ExpansionTile. Custom templates listed separately |
| `lib/features/reports/widgets/report_action_bar.dart` | Toolbar extracted from DynamicReportForm: scan/save/export/photos/signatures |
| `lib/features/reports/widgets/report_details_grid.dart` | Header fields extracted from DynamicReportForm: text/dropdown/date/calculated/number/textarea |
| `lib/features/reports/widgets/report_entry_table.dart` | Data-entry table extracted from DynamicReportForm: scrollable rows, add/delete |
| `lib/features/reports/widgets/template_upload_button.dart` | FAB that triggers file pick → parse → map → save flow |
| `lib/features/reports/widgets/scan_camera_page.dart` | Full-screen mobile scanner (barcode + QR) |
| `lib/features/sharing/share_access_screen.dart` | Invite users, manage shared access |
| `lib/features/chat/project_chat_screen.dart` | In-project real-time chat |
| `lib/features/notifications/notifications_screen.dart` | Push notification inbox |
| `lib/features/visualization/visualization_home_screen.dart` | Charts feature home |
| `lib/features/visualization/visualization_kpi_screen.dart` | KPI charts with inline `ChartExporter` |

### Shared UI
| File | Purpose |
|------|---------|
| `lib/screens/field_mapping_screen.dart` | 3-step wizard for mapping template fields (Review → Configure → Save) |
| `lib/widgets/photo_manager_modal.dart` | Photo capture/gallery upload to Firebase Storage |
| `lib/widgets/signature_manager_modal.dart` | Digital signature pad + upload to Firebase Storage |

---

## Firestore Data Model

```
/users/{uid}
│   profile fields: displayName, email, company, role,
│                   fcmToken, createdAt, lastSeen
│
├── /reports/{schemaId}
│   │   (schema-level document — title, type, metadata)
│   │
│   └── /items/{itemId}
│           reportId, schemaId, schemaTitle, status,
│           reportStatus, details {}, entries [], createdAt,
│           updatedAt, projectId, reportNumber
│
├── /stats/summary
│       totalReports, passCount, failCount, pendingCount,
│       repairCount, totalWelds, acceptedWelds, rejectedWelds
│
├── /subscription
│   ├── /info         — hasAccess, plan, stripeCustomerId, stripeSubscriptionId,
│   │                   currentPeriodEnd, updatedAt  [write: server-only via Admin SDK]
│   ├── /trial        — owner writable
│   └── /credits      — owner writable
│
├── /custom_schemas/{schemaId}
│       schemaId, title, schema {}, fileName,
│       createdAt, updatedAt, createdBy
│
├── /projects/{projectId}
│       name, clientName, location, type, status,
│       startDate, endDate, reportCount, createdAt, updatedAt
│
└── /notifications/{notifId}
        title, body, read, createdAt, type

/pricing/{region}
    currency, currencySymbol, region,
    one_report {amount, stripePriceId, credits},
    five_reports {amount, stripePriceId, credits, promotionLabel},
    monthly {amount, stripePriceId, isRecurring}

/materials/{id}
    (shared reference catalog — admin write only)
```

---

## Security Rules (deployed)

### Firestore (`firestore.rules`)
- `/users/{uid}` — owner read/write
- `/users/{uid}/reports/**` — owner read/write
- `/users/{uid}/stats/**` — owner read/write
- `/users/{uid}/subscription/info` — **write: false** (server-only via Admin SDK)
- `/users/{uid}/subscription/trial`, `/credits` — owner writable
- `/users/{uid}/custom_schemas/**` — owner read/write
- `/users/{uid}/notifications/**` — owner read/write
- `/users/{uid}/projects/**` — owner read/write
- `/materials/{id}` — read: authenticated; write: admin only
- Collaboration: `sharedWith` subcollection checked for `read` / `write` permissions

### Storage (`storage.rules`)
- `/branding/**` — read: public; write: admin only
- `/reports/{userId}/**` — owner read/write
- `/users/{userId}/**` — owner read/write
- `/users/{userId}/channels/{channelId}/attachments/**` — owner write; collaborator read via `firestore.get()`
- Everything else — deny

---

## Subscription and Payment Flow

```
User taps upgrade
    → upgrade_options_dialog.dart
        → pricing_service.dart (loads tier from Firestore or fallback)
        → payment_service.dart
            → Cloud Function: createCheckoutSession / createSubscription
                → Stripe API creates session
                    → Returns checkout URL
        → Opens Stripe URL in browser
            → User completes payment on Stripe
                → Stripe sends webhook event
                    → Cloud Function: stripeWebhook (validates signature)
                        → Sets users/{uid}/subscription/info.hasAccess = true (Admin SDK)
                        → Increments credits (for pay-per-report)
```

Redirect URLs: `https://weldqai.com/payment-success` / `https://weldqai.com/payment-cancel`

---

## Template Upload Pipeline

```
User taps "Upload Template" FAB (in ReportCatalogScreen)
    → template_upload_button.dart
        → FilePicker (xlsx / xls / pdf)
        → enhanced_template_parser.dart
            → Excel: reads sheet, detects header rows, extracts cell addresses
            → PDF: syncfusion text extraction, column detection
            → Returns: {details: [...fields], tables: [{columns: [...]}]}
        → field_mapping_screen.dart (3-step wizard)
            Step 1: Review — drag fields to Details / Entries sections
            Step 2: Configure — set types (text/number/date/dropdown/calculated/textarea)
            Step 3: Save — name and describe the template
        → template_manager.dart (saves to SharedPreferences)
        → Firestore: users/{uid}/custom_schemas/{schemaId}
        → Navigates to /qc_report with the new schemaId
```

---

## Project Workflow (implemented Feb 2026)

```
Dashboard (project_dashboard_screen.dart)
    Bottom nav: Home | Projects | KPIs | Team
    FAB: "New Project" → CreateProjectScreen

Projects tab → ProjectsListScreen
    Filter: Open | Closed | All  (client-side — no composite index required)
    Streams: ProjectRepository.listProjectsStream()

    Tap project card → ProjectDetailScreen
        Project info card (tap to edit → CreateProjectScreen)
        "Start New Inspection" card → ReportCatalogScreen
        Quick stats (reportCount from denormalised project field)
        AppBar: status chip toggle | edit | close/reopen | delete

    Save report in DynamicReportForm
        → report_repository.saveReport(payload)
            → if new report and payload['projectId'] != null
                → ProjectRepository.incrementReportCount(uid, projectId)
```

---

## Offline Sync Strategy

**Current state:** Firestore offline persistence is enabled (`CACHE_SIZE_UNLIMITED`).
Reads/writes are automatically cached. `sync_service.dart` paths fixed Feb 2026.

**Offline UI** exists but is not yet wired in. Files preserved in `archive/offline_ui/`:
- `offline_mode_screen.dart`
- `widgets/offline_badge.dart`
- `widgets/sync_banner.dart`

**Future (P3.2):** Move to `lib/features/offline/`, wire into dashboard using `connectivity_plus`.

---

## Report Form Architecture (after P2.2 split)

`dynamic_report_form.dart` (956 lines) — parent state, schema logic, Firebase calls, formula engine
```
DynamicReportForm
├── ReportActionBar        (lib/features/reports/widgets/report_action_bar.dart, 128 lines)
│       scan / save / export / photos / signatures toolbar
├── ReportDetailsGrid      (lib/features/reports/widgets/report_details_grid.dart, 298 lines)
│       header fields: text / dropdown / date / calculated / number / textarea
└── ReportEntryTable       (lib/features/reports/widgets/report_entry_table.dart, 322 lines)
        scrollable data-entry table: row add / delete / inline edit
```
Child widgets receive data + callbacks; each manages its own `setState` for display only.
**Do not add code back to `dynamic_report_form.dart`** — split further if needed.

---

## Known Remaining Technical Debt

| Item | Severity | Location | Notes |
|------|----------|----------|-------|
| iOS bundle ID placeholder | HIGH | `firebase_options.dart`, `ios/Runner/Info.plist` | Needs Apple Developer account + `flutterfire configure` |
| applicationId placeholder `com.example.weldqai_app` | HIGH | `android/app/build.gradle.kts` | Must match Firebase registration before Play Store submission |
| Offline UI not wired | MEDIUM | `archive/offline_ui/` | P3.2 — wire with `connectivity_plus` |
| Server-side subscription enforcement | MEDIUM | `functions/index.js` | P3.1 — add per-function middleware check |
| `ndtKpisStream()` missing composite index | MEDIUM | `user_data_repository.dart` | Add to `firestore.indexes.json` |
| Export service not tested | MEDIUM | `export_service.dart` | Needs golden tests |
| No E2E test coverage | MEDIUM | `test/` | `payment_service` needs Stripe test mode |

---

## CI / CD

| Item | Status |
|------|--------|
| GitHub Actions pipeline | ✅ Green |
| Flutter version pinned to `3.32.8` | ✅ |
| Secrets: `FIREBASE_OPTIONS_DART`, `GOOGLE_SERVICES_JSON`, `FIREBASE_WEB_CONFIG_JS` | ✅ Set |
| `firebase_options.dart` excluded from analysis | ✅ |
| `web/firebase-config.js` gitignored, loaded via `<script src>` | ✅ |
| APK artifact uploaded on each CI run | ✅ |
| `flutter analyze --fatal-warnings` | ✅ 0 issues |

---

## Test Coverage

| File | Type | Covers |
|------|------|--------|
| `test/unit/services/formula_engine_test.dart` | Unit | Arithmetic, field refs, conditionals, circular-dep detection |
| `test/unit/services/subscription_service_test.dart` | Unit (FakeFirestore) | `getStatus()`, `canCreateReport()`, `watchStatus()` stream |
| `test/unit/services/sync_service_test.dart` | Unit | P1.2 regression — wrong-path bug |
| `test/unit/repositories/report_repository_test.dart` | Unit (FakeFirestore) | `saveReport()` CRUD, path correctness |
| `test/widget/auth_screen_test.dart` | Widget | Form rendering, validation |

**Coverage gaps:** `export_service.dart` (golden tests), `payment_service.dart` (Stripe test mode), `ReportDetailsGrid`/`ReportEntryTable`, E2E flow.
